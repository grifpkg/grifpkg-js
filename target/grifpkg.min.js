var Service,__awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(s,n){function o(e){try{a(i.next(e))}catch(e){n(e)}}function u(e){try{a(i.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,u)}a((i=i.apply(e,t||[])).next())}))};class APIException extends Error{constructor(e){super(e),Object.setPrototypeOf(this,APIException.prototype)}}class Suggestable{suggest(e,t,r){return __awaiter(this,void 0,void 0,(function*(){let i={urlSchema:e};if(null!=t&&null!=r&&(i.jsonURL=t,i.jsonPath=r),this instanceof Release)i.release=this.id;else{if(!(this instanceof Resource))throw new Error("unsupported suggestable class");i.resource=this.id}let s=yield Grif.request("/resource/suggest/url/",i);if(Array.isArray(s)){let e=[];return s.forEach((t=>{e.push(UrlSuggestionTestResult.fromObject(t))})),e}return UrlSuggestionTestResult.fromObject(s)}))}}class Resource extends Suggestable{constructor(e,t,r,i,s,n,o,u,a,l){super(),this.id=e,this.service=t,this.resourceId=r,this.paid=i,this.name=s,this.author=n,this.downloads=o,this.ratings=u,this.rating=a,this.description=l}static fromId(e){return __awaiter(this,void 0,void 0,(function*(){let t=yield Grif.request("/resource/get/",{resource:e});return Resource.fromObject(t)}))}getReleases(){return __awaiter(this,void 0,void 0,(function*(){let e=yield Grif.request("/resource/release/list/",{resource:this.id}),t=[];return e.forEach((e=>{t.push(Release.fromObject(e))})),t}))}getRelease(e=null){return __awaiter(this,void 0,void 0,(function*(){return Release.fromId(null,this,e)}))}static fromObject(e){return new Resource(e.id,e.service,e.resourceId,Boolean(e.paid),e.name,Author.fromObject(e.author),e.downloads,e.ratings,e.rating,e.description)}}class Release extends Suggestable{constructor(e,t,r,i,s,n,o,u,a,l,c,h,d,f,g,m){super(),this.service=e,this.id=t,this.version=r,this.creation=i,this.url=s,this.originalURL=n,this.fileName=o,this.fileExtension=u,this.fileSize=a,this.manifestName=l,this.manifestAuthors=c,this.manifestVersion=h,this.manifestVersionAPI=f,this.manifestDependencies=g,this.manifestOptionalDependencies=m}static fromId(e,t=null,r=null){return __awaiter(this,void 0,void 0,(function*(){let i=yield Grif.request("/resource/release/get/",{release:e,resource:null!=t?t.id:null,version:r});return Release.fromObject(i)}))}download(){return __awaiter(this,void 0,void 0,(function*(){let e=yield Grif.request("/resource/release/download/",{release:this.id});return DownloadableRelease.fromObject(e)}))}static fromObject(e){return new Release(e.service,e.id,e.version,new Date(1e3*e.creation),e.url,e.originalURL,e.fileName,e.fileExtension,e.fileSize,e.manifestName,e.manifestAuthors,e.manifestVersion,e.manifestMain,e.manifestVersionAPI,e.manifestDependencies,e.manifestOptionalDependencies)}}class Grif{constructor(e=null){if(Grif.session=e,null==e)try{Grif.session=this.fromBrowser()}catch(e){}}isAuthenticated(){return null!=Grif.session}getSession(){return new Session(null,Grif.session,null,null,null,null,null)}queryResource(e,t=null,r=null){return __awaiter(this,void 0,void 0,(function*(){null!=r&&(r=r);let i=yield Grif.request("/resource/query/",{name:e,author:t,service:Number(r)}),s=[];return i.forEach((e=>{s.push(Resource.fromObject(e))})),s}))}static login(e=!0){return __awaiter(this,void 0,void 0,(function*(){if(null==window)throw new APIException("In order to create a login popup, you must be executing grifpkg from a Document Object Model");{let t=600,r=400;const i=window.top.outerHeight/2+window.top.screenY-t/2,s=window.top.outerWidth/2+window.top.screenX-r/2;let n=window.open("https://api.grifpkg.com/rest/1/login/","Login",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${r}, height=${t}, top=${i}, left=${s}`),o=!0,u=setInterval((()=>{if(n.closed&&o)throw o=!1,new APIException("The popup was closed before any session was retrieved")}),50),a=yield new Promise((function(e,t){window.addEventListener("message",(t=>{o&&"https://api.grifpkg.com"==t.origin&&(o=!1,e(t))}),!1)}));switch(a.data.type){case"login":if("error"in a.data.data)throw new APIException(a.data.data.error);return e&&(localStorage.setItem(btoa("grifpkg"),btoa(String(a.data.data.session.hash))),Grif.session=String(a.data.data.session.hash)),o=!1,clearInterval(u),n.closed||n.close(),Session.fromObject(a.data.data.session)}}}))}logout(e=!0){return __awaiter(this,void 0,void 0,(function*(){let t=yield Grif.request("/session/close/");return e&&(Grif.session=null,localStorage.removeItem(btoa("grifpkg"))),Session.fromObject(t)}))}static request(e,t=null,r=null){return __awaiter(this,void 0,void 0,(function*(){let i={method:null==t?"GET":"POST",mode:"cors",cache:"no-cache",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:null!=r?`Bearer ${r}`:null!=Grif.session?`Bearer ${Grif.session}`:null},redirect:"follow",referrerPolicy:"no-referrer"};null!=t&&(i.body=JSON.stringify(t));const s=yield fetch(`https://api.grifpkg.com/rest/1${e}`,i);let n=null;try{n=JSON.parse(yield s.text())}catch(e){}if(s.status>=300||s.status<200)throw new APIException(null!=n&&"object"==typeof n&&"error"in n?n.error:`server replied with ${String(s.status)}`);return n}))}fromBrowser(){if(null==localStorage)throw new Error("outside localstorage context");let e=localStorage.getItem(btoa("grifpkg"));return null==e?null:atob(e)}}try{module.exports=Grif,module.exports.Resource=Resource,module.exports.Release=Release;try{global.fetch=require("node-fetch")}catch(e){}}catch(e){}class Account{constructor(e,t,r){this.id=e,this.username=t,this.githubId=r}getId(){return this.id}getUsername(){return this.username}getGithubId(){return this.githubId}static fromObject(e){return new Account(e.id,e.username,e.githubId)}update(){return __awaiter(this,void 0,void 0,(function*(){let e=yield Grif.request("/session/account/");return this.id=e.id,this.username=e.username,this.githubId=e.githubId,this}))}getSessions(){return __awaiter(this,void 0,void 0,(function*(){let e=new Array;return(yield Grif.request("/session/list/")).forEach((t=>{e.push(Session.fromObject(t))})),e}))}getNotifications(){return __awaiter(this,void 0,void 0,(function*(){let e=new Array;return(yield Grif.request("/notifications/get/")).forEach((t=>{e.push(Alert.fromObject(t))})),e}))}commercialSubscribe(e){return __awaiter(this,void 0,void 0,(function*(){yield Grif.request("/notifications/commercial/",{subscribe:e})}))}isCommercialSubscribed(){return __awaiter(this,void 0,void 0,(function*(){return yield Grif.request("/notifications/config/")}))}setBillingAddress(e,t,r,i,s,n,o,u){return __awaiter(this,void 0,void 0,(function*(){yield Grif.request("/billing/address/set/",{line1:e,line2:t,postCode:r,city:i,state:s,country:n,phone:o,name:u})}))}getBillingAddress(){return __awaiter(this,void 0,void 0,(function*(){return yield Grif.request("/billing/address/get/")}))}listSources(){return __awaiter(this,void 0,void 0,(function*(){let e=yield Grif.request("/billing/source/list/");return SourceList.fromObject(e)}))}setDefaultSource(e){return __awaiter(this,void 0,void 0,(function*(){yield Grif.request("/billing/source/default/",{source:e})}))}attachSource(e){return __awaiter(this,void 0,void 0,(function*(){yield Grif.request("/billing/source/attach/",{source:e})}))}detachSource(e){return __awaiter(this,void 0,void 0,(function*(){yield Grif.request("/billing/source/detach/",{source:e})}))}}class Session{constructor(e,t,r,i,s,n,o){this.id=e,this.hash=t,this.userAgent=r,this.creation=i,this.expiry=s,this.city=n,this.country=o}static fromObject(e){return new Session(e.id,e.hash,e.userAgent,new Date(1e3*e.creation),null==e.expiry?null:new Date(1e3*e.expiry),e.city,e.country)}getId(){return this.id}getUserAgent(){return this.userAgent}getCreation(){return this.creation}getExpiry(){return this.expiry}getCity(){return this.city}getCountry(){return this.country}getAccount(){return new Account(null,null,null)}close(){return __awaiter(this,void 0,void 0,(function*(){let e=yield Grif.request("/session/close/",null,this.hash);return Session.fromObject(e)}))}update(){return __awaiter(this,void 0,void 0,(function*(){let e=yield Grif.request("/session/get/");return this.id=e.id,this.hash=e.hash,this.userAgent=e.userAgent,this.creation=new Date(1e3*e.creation),this.expiry=null==e.expiry?null:new Date(1e3*e.expiry),this.city=e.city,this.country=e.country,this}))}}class SourceList{constructor(e,t){this.default=e,this.sources=t}static fromObject(e){let t=new Array;return e.sources.forEach((e=>{t.push(e)})),new SourceList(e.default,t)}getDefault(){return this.default}getAll(){return this.sources}}class Alert{constructor(e,t,r,i,s,n,o){this.id=e,this.creation=t,this.seen=r,this.action=i,this.subject=s,this.text=n,this.commercial=o}getId(){return this.id}getCreation(){return this.creation}getSeen(){return this.seen}getAction(){return this.action}getSubject(){return this.subject}getText(){return this.text}isCommercial(){return this.commercial}static fromObject(e){return new Alert(e.id,new Date(1e3*e.creation),null==e.seen?null:new Date(1e3*e.seen),e.action,e.subject,e.text,e.commercial)}}class Author{constructor(e,t,r,i){this.service=e,this.id=t,this.username=r,this.authorId=i}static fromObject(e){return new Author(e.service,e.id,e.username,e.authorId)}}class DownloadableRelease{constructor(e,t,r){this.url=e,this.release=t,this.resource=r}static fromObject(e){return new DownloadableRelease(e.url,Release.fromObject(e.release),null!=e.resource?Resource.fromObject(e.resource):null)}}!function(e){e[e.Unknown=-1]="Unknown",e[e.SpigotMC=0]="SpigotMC"}(Service||(Service={}));class UrlSuggestion{constructor(e,t,r,i,s,n,o,u,a,l){this.id=e,this.suggestedBy=t,this.approvedBy=r,this.url=i,this.urlSchema=s,this.jsonURL=n,this.jsonPath=o,this.fileName=u,this.creation=a,this.uses=l}static fromObject(e){return new UrlSuggestion(e.id,Account.fromObject(e.suggestedBy),null!=e.approvedBy?Account.fromObject(e.approvedBy):null,e.url,e.urlSchema,e.jsonURL,e.jsonPath,e.fileName,new Date(1e3*e.creation),e.uses)}}class UrlSuggestionTestResult{constructor(e,t,r,i){this.release=e,this.urlSuggestion=t,this.result=r,this.message=i}static fromObject(e){return new UrlSuggestionTestResult(Release.fromObject(e.release),null!=e.urlSuggestion?UrlSuggestion.fromObject(e.urlSuggestion):null,Boolean(e.result),e.message)}}